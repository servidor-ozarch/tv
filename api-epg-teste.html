<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Programação TV → Firebase</title>
</head>
<body>
<script>
// ========================
// Configuração
// ========================
const API_PROXY = "https://api.allorigins.win/raw?url=";
const BASE_URL = "https://tvmap.com.br/";

// Mapeamento de categorias para gêneros
const generos = {
    'ação': ['ação', 'luta', 'artes marciais', 'guerra', 'combate', 'batalha', 'herói', 'super-herói'],
    'aventura': ['aventura', 'expedição', 'missão', 'viagem', 'exploração', 'descoberta'],
    'terror': ['terror', 'horror', 'suspense', 'thriller', 'sobrenatural', 'assustador', 'medo'],
    'ficção científica': ['ficção científica', 'sci-fi', 'futuro', 'espacial', 'alienígena', 'nave', 'robô'],
    'drama': ['drama', 'emocionante', 'romance', 'família', 'relacionamento', 'sentimental'],
    'comédia': ['comédia', 'humor', 'divertido', 'engraçado', 'riso', 'zoação'],
    'documentário': ['documentário', 'realidade', 'história', 'biografia', 'fatos reais'],
    'esportes': ['esporte', 'futebol', 'jogo', 'competição', 'campeonato', 'atleta'],
    'notícias': ['notícias', 'jornal', 'informação', 'atualidades', 'reportagem'],
    'infantil': ['infantil', 'criança', 'desenho', 'animação', 'kids', 'educativo']
};

// Mapeamento de dias para formato TV Map
const diasMap = {
    'domingo': 'domingo',
    'segunda': 'segunda-feira', 
    'terca': 'terca-feira',
    'quarta': 'quarta-feira',
    'quinta': 'quinta-feira',
    'sexta': 'sexta-feira',
    'sabado': 'sabado'
};

// ========================
// Detecta parâmetros ?canal=xxx&dia=xxx
// ========================
const urlParams = new URLSearchParams(location.search);
const canal = urlParams.get('canal') || 'Claro-TV';
const diaParam = urlParams.get('dia') || new Date().toLocaleString('pt-BR', { weekday: 'long' }).toLowerCase();
const diaSlug = diasMap[diaParam] || 'domingo';

// ========================
// Funções auxiliares
// ========================
function getCurrentDateFormatted() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    return `${day}-${month}-${year}`;
}

function formatData(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

function formatHora(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}

function detectarGenero(titulo, descricao) {
    const texto = `${titulo} ${descricao}`.toLowerCase();
    
    for (const [genero, palavrasChave] of Object.entries(generos)) {
        for (const palavra of palavrasChave) {
            if (texto.includes(palavra)) {
                return genero;
            }
        }
    }
    
    return 'outros';
}

function extrairHorarios(texto) {
    const horarioRegex = /(\d{1,2}:\d{2})/g;
    const horarios = texto.match(horarioRegex) || [];
    return horarios;
}

// ========================
// Parse HTML da programação TV Map
// ========================
function parseGradeTVMap(html) {
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const programRows = Array.from(doc.querySelectorAll('.zc-row.outerTable'));
    const now = Date.now();
    
    const programas = programRows.map(row => {
        try {
            // Extrai informações do canal
            const canalEl = row.querySelector('.zc-st-a');
            const canalNome = canalEl ? canalEl.textContent.trim() : '';
            const canalNumero = row.querySelector('.numcanal') ? row.querySelector('.numcanal').textContent.trim() : '';
            
            // Encontra a célula do programa que está passando AGORA
            const programaCell = row.querySelector('.zc-pg .tempo');
            if (!programaCell) return null;
            
            const programaContainer = programaCell.closest('.zc-pg');
            const programaLink = programaContainer.querySelector('a.zc-pg-t');
            const horarioTerminoEl = programaContainer.querySelector('.zc-pg-e');
            
            const programaNome = programaLink ? programaLink.textContent.trim() : '';
            const programaUrl = programaLink ? programaLink.getAttribute('href') : '';
            const horarioTermino = horarioTerminoEl ? horarioTerminoEl.textContent.trim() : '';
            
            // Extrai informações de tempo e progresso
            const tempoElement = programaContainer.querySelector('.duracao-filme');
            
            let progresso = 0;
            let tempoDecorrido = '0min';
            let tempoTotal = '0min';
            
            if (tempoElement) {
                const tempoText = tempoElement.textContent;
                const tempoMatch = tempoText.match(/(\d+min)\/(\d+min)/);
                if (tempoMatch) {
                    tempoDecorrido = tempoMatch[1];
                    tempoTotal = tempoMatch[2];
                    
                    // Calcula progresso percentual
                    const decorrido = parseInt(tempoMatch[1]);
                    const total = parseInt(tempoMatch[2]);
                    progresso = Math.round((decorrido / total) * 100);
                }
            }
            
            // Tenta extrair horário de início
            const horarios = extrairHorarios(programaContainer.textContent);
            const horarioInicio = horarios.length > 0 ? horarios[0] : '';
            
            // Detecta gênero baseado no título
            const genero = detectarGenero(programaNome, '');
            
            return {
                data_atual: formatData(new Date()),
                canal: canalNome,
                numero_canal: canalNumero,
                programa: programaNome,
                programa_url: programaUrl,
                horario_inicio: horarioInicio,
                horario_termino: horarioTermino,
                tempo_decorrido: tempoDecorrido,
                tempo_total: tempoTotal,
                progresso: progresso,
                genero: genero,
                isNow: true,
                timestamp: now,
                consulta: new Date().toISOString()
            };
        } catch (error) {
            console.error('Erro ao parsear linha:', error);
            return null;
        }
    }).filter(item => item !== null);
    
    return programas;
}

// ========================
// Envia JSON para Firebase
// ========================
async function enviarParaFirebase(canal, dia, jsonData) {
    try {
        const url = `https://projeto-aplicativo-android-default-rtdb.firebaseio.com/epg/${canal}/${dia}.json`;
        await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jsonData)
        });
        console.log('Dados enviados para Firebase com sucesso');
    } catch(err) {
        console.error('Erro ao enviar para Firebase:', err);
    }
}

// ========================
// Função principal
// ========================
async function getProgramacao(canal, dia) {
    try {
        // Formata a data atual para a URL
        const dataAtual = getCurrentDateFormatted();
        
        // Usa horário atual para pegar a grade correta
        const now = new Date();
        const horaAtual = `${String(now.getHours()).padStart(2, '0')}.${String(now.getMinutes()).padStart(2, '0')}hs`;
        
        // Constrói a URL baseada no canal
        let url;
        if (canal.toLowerCase() === 'claro-tv') {
            url = `${BASE_URL}${canal}/${dataAtual}/${horaAtual}`;
        } else {
            url = `${BASE_URL}${canal}/${dia}/${horaAtual}`;
        }
        
        const resp = await fetch(API_PROXY + encodeURIComponent(url));
        
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        
        const html = await resp.text();
        const programacao = parseGradeTVMap(html);
        
        // Exibe resultado na página
        document.body.innerHTML = `<pre>${JSON.stringify(programacao, null, 2)}</pre>`;
        
        // Envia para Firebase
        await enviarParaFirebase(canal, dia, programacao);
        
        // Interface com Android
        if (window.JsonInterface && window.JsonInterface.salvarJson) {
            window.JsonInterface.salvarJson(JSON.stringify(programacao, null, 2));
        }
        
    } catch(err) {
        console.error('Erro ao carregar programação:', err);
        document.body.innerHTML = `<pre>${JSON.stringify({error: "Falha ao carregar programação", details: err.message}, null, 2)}</pre>`;
    }
}

// ========================
// Execução principal
// ========================
getProgramacao(canal, diaSlug);

// Atualização automática a cada 60s
setInterval(() => getProgramacao(canal, diaSlug), 60000);
</script>
</body>
</html>
