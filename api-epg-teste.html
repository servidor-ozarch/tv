<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Programação TV → Firebase</title>
</head>
<body>
<script>
// ========================
// Configuração
// ========================
// Teste com diferentes proxies
const PROXIES = [
    "https://api.allorigins.win/raw?url=",
    "https://corsproxy.io/?",
    "https://cors-anywhere.herokuapp.com/",
    "https://proxy.cors.sh/",
    "" // Tentativa direta (pode falhar por CORS)
];

let currentProxyIndex = 0;
function getProxy() {
    return PROXIES[currentProxyIndex];
}

function rotateProxy() {
    currentProxyIndex = (currentProxyIndex + 1) % PROXIES.length;
    console.log('Trocando para proxy:', getProxy());
}

// Mapeamento de categorias para gêneros
const generos = {
    'ação': ['ação', 'luta', 'artes marciais', 'guerra', 'combate', 'batalha', 'herói', 'super-herói'],
    'aventura': ['aventura', 'expedição', 'missão', 'viagem', 'exploração', 'descoberta'],
    'terror': ['terror', 'horror', 'suspense', 'thriller', 'sobrenatural', 'assustador', 'medo'],
    'ficção científica': ['ficção científica', 'sci-fi', 'futuro', 'espacial', 'alienígena', 'nave', 'robô'],
    'drama': ['drama', 'emocionante', 'romance', 'família', 'relacionamento', 'sentimental'],
    'comédia': ['comédia', 'humor', 'divertido', 'engraçado', 'riso', 'zoação'],
    'documentário': ['documentário', 'realidade', 'história', 'biografia', 'fatos reais'],
    'esportes': ['esporte', 'futebol', 'jogo', 'competição', 'campeonato', 'atleta'],
    'notícias': ['notícias', 'jornal', 'informação', 'atualidades', 'reportagem'],
    'infantil': ['infantil', 'criança', 'desenho', 'animação', 'kids', 'educativo']
};

// ========================
// Detecta parâmetros ?canal=xxx&dia=xxx
// ========================
const urlParams = new URLSearchParams(location.search);
const canal = urlParams.get('canal') || 'tv-aberta';
let diaParam = urlParams.get('dia') || new Date().toLocaleString('pt-BR', { weekday: 'long' }).toLowerCase();

// Corrige nome dos dias para o formato do TV Map
const diasMap = {
    'domingo': 'domingo',
    'segunda': 'segunda-feira', 
    'segunda-feira': 'segunda-feira',
    'terca': 'terca-feira',
    'terça': 'terca-feira',
    'terça-feira': 'terca-feira',
    'quarta': 'quarta-feira',
    'quarta-feira': 'quarta-feira',
    'quinta': 'quinta-feira',
    'quinta-feira': 'quinta-feira',
    'sexta': 'sexta-feira',
    'sexta-feira': 'sexta-feira',
    'sabado': 'sabado',
    'sábado': 'sabado'
};

const diaSlug = diasMap[diaParam] || 'domingo';

// ========================
// Funções auxiliares
// ========================
function getCurrentDateFormatted() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    return `${day}-${month}-${year}`;
}

function formatData(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

function detectarGenero(titulo) {
    const texto = titulo.toLowerCase();
    
    for (const [genero, palavrasChave] of Object.entries(generos)) {
        for (const palavra of palavrasChave) {
            if (texto.includes(palavra)) {
                return genero;
            }
        }
    }
    
    return 'outros';
}

// ========================
// Parse HTML alternativo (mais simples)
// ========================
function parseGradeSimples(html) {
    try {
        const now = new Date();
        const horaAtual = now.getHours();
        const minutoAtual = now.getMinutes();
        
        // Encontra programas que estão no ar
        const programasEmExibicao = [];
        
        // Extrai informações básicas - abordagem mais simples
        const canalMatch = html.match(/<title>([^<]+)<\/title>/);
        const canalNome = canalMatch ? canalMatch[1].replace('Guia de Programação da', '').trim() : 'Canal Desconhecido';
        
        // Tenta encontrar programas atuais de forma mais simples
        const programaRegex = /<a[^>]+class="zc-pg-t"[^>]*>([^<]+)<\/a>/g;
        let match;
        
        while ((match = programaRegex.exec(html)) !== null) {
            const programaNome = match[1].trim();
            if (programaNome) {
                programasEmExibicao.push({
                    data_atual: formatData(now),
                    canal: canalNome,
                    programa: programaNome,
                    horario_consulta: `${String(horaAtual).padStart(2, '0')}:${String(minutoAtual).padStart(2, '0')}`,
                    genero: detectarGenero(programaNome),
                    isNow: true,
                    timestamp: now.getTime(),
                    consulta: now.toISOString()
                });
            }
        }
        
        return programasEmExibicao.slice(0, 5); // Retorna apenas os primeiros 5 programas
    } catch (error) {
        console.error('Erro no parse simples:', error);
        return [];
    }
}

// ========================
// Envia JSON para Firebase
// ========================
async function enviarParaFirebase(canal, dia, jsonData) {
    try {
        const url = `https://projeto-aplicativo-android-default-rtdb.firebaseio.com/epg/${canal}/${dia}.json`;
        const response = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jsonData)
        });
        
        if (response.ok) {
            console.log('Dados enviados para Firebase com sucesso');
        }
    } catch(err) {
        console.error('Erro ao enviar para Firebase:', err);
    }
}

// ========================
// Função principal com fallbacks
// ========================
async function getProgramacao(canal, dia) {
    let tentativa = 0;
    const maxTentativas = PROXIES.length;
    
    while (tentativa < maxTentativas) {
        try {
            const proxy = getProxy();
            let url;
            
            // Diferentes formatos de URL para testar
            const urlsParaTestar = [
                `https://tvmap.com.br/${canal}/${dia}`,
                `https://tvmap.com.br/${canal}`,
                `https://www.tvmap.com.br/${canal}/${dia}`,
                `https://www.tvmap.com.br/${canal}`
            ];
            
            let html = null;
            
            // Tenta cada URL até uma funcionar
            for (const testUrl of urlsParaTestar) {
                try {
                    const fullUrl = proxy ? proxy + encodeURIComponent(testUrl) : testUrl;
                    console.log('Tentando URL:', fullUrl);
                    
                    const resp = await fetch(fullUrl, {
                        headers: {
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        },
                        signal: AbortSignal.timeout(10000) // Timeout de 10 segundos
                    });
                    
                    if (resp.ok) {
                        html = await resp.text();
                        break;
                    }
                } catch (e) {
                    console.log('URL falhou:', testUrl);
                    continue;
                }
            }
            
            if (!html) {
                throw new Error('Todas as URLs falharam');
            }
            
            const programacao = parseGradeSimples(html);
            
            if (programacao.length === 0) {
                // Fallback: retorna dados simulados se não conseguir parsear
                programacao.push({
                    data_atual: formatData(new Date()),
                    canal: canal,
                    programa: 'Programação não disponível',
                    horario_consulta: new Date().toLocaleTimeString('pt-BR'),
                    genero: 'informação',
                    isNow: true,
                    timestamp: Date.now(),
                    consulta: new Date().toISOString(),
                    observacao: 'Dados simulados - site pode ter mudado'
                });
            }
            
            // Exibe resultado na página
            document.body.innerHTML = `<pre>${JSON.stringify(programacao, null, 2)}</pre>`;
            
            // Envia para Firebase
            await enviarParaFirebase(canal, dia, programacao);
            
            // Interface com Android
            if (window.JsonInterface && window.JsonInterface.salvarJson) {
                window.JsonInterface.salvarJson(JSON.stringify(programacao, null, 2));
            }
            
            return; // Sucesso, sai do loop
            
        } catch(err) {
            tentativa++;
            console.error(`Tentativa ${tentativa}/${maxTentativas} falhou:`, err);
            
            if (tentativa < maxTentativas) {
                rotateProxy();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Espera 1 segundo
            } else {
                document.body.innerHTML = `<pre>${JSON.stringify({
                    error: "Falha ao carregar programação", 
                    details: "Site pode estar bloqueando acesso",
                    suggestion: "Tente novamente mais tarde ou verifique se o site tvmap.com.br está acessível"
                }, null, 2)}</pre>`;
            }
        }
    }
}

// ========================
// Execução principal
// ========================
getProgramacao(canal, diaSlug);

// Atualização automática a cada 2 minutos
setInterval(() => getProgramacao(canal, diaSlug), 120000);
</script>
</body>
</html>
