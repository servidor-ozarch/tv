<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Programação TV → Firebase</title>
</head>
<body>
<script>
// ========================
// Configuração
// ========================
const API_PROXY = "https://api.allorigins.win/raw?url=";
const BASE_URL = "https://tvinside.com.br/programacao_tv/";
const dias = ['domingo','segunda','terca','quarta','quinta','sexta','sabado'];

// ========================
// Detecta parâmetros ?canal=xxx&dia=xxx
// ========================
const urlParams = new URLSearchParams(location.search);
const canal = urlParams.get('canal') || 'premiere_clubes';
const dia = urlParams.get('dia') || dias[new Date().getDay()];

// ========================
// Formatação de data e hora
// ========================
function formatData(dt){
  if(!dt) return '';
  const d = new Date(dt);
  const day = String(d.getDate()).padStart(2,'0');
  const month = String(d.getMonth()+1).padStart(2,'0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

function formatHora(dt){
  if(!dt) return '';
  const d = new Date(dt);
  const hours = String(d.getHours()).padStart(2,'0');
  const minutes = String(d.getMinutes()).padStart(2,'0');
  return `${hours}:${minutes}`;
}

// ========================
// Parse HTML da programação
// ========================
function parseGrade(html){
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const regs = Array.from(doc.querySelectorAll('.registro.programa_data'));
  const now = Date.now();

  return regs.map(el=>{
    const titleEl = el.querySelector('.titulo');
    const catEl   = el.querySelector('.evento_box small');
    const sinopseEl = el.querySelector('.descricao_programa'); 
    const classificacaoEl = el.querySelector('.classificacao'); 
    const faixaEl = el.querySelector('.faixa_etaria'); 

    const dti = el.getAttribute('dti');
    const dtf = el.getAttribute('dtf');

    const startDate = dti ? new Date(dti.replace(' ','T')) : null;
    const endDate   = dtf ? new Date(dtf.replace(' ','T')) : null;

    const isNow = (startDate && endDate && now >= startDate.getTime() && now < endDate.getTime()) || el.classList.contains('check_noar');

    return {
      data_inicio: formatData(startDate),
      hora_inicio: formatHora(startDate),
      data_fim: formatData(endDate),
      hora_fim: formatHora(endDate),
      titulo: titleEl ? titleEl.textContent.trim() : '',
      categoria: catEl ? catEl.textContent.trim() : '',
      sinopse: sinopseEl ? sinopseEl.textContent.trim() : '',
      classificacao: classificacaoEl ? classificacaoEl.textContent.trim() : '',
      faixa: faixaEl ? faixaEl.textContent.trim() : '',
      isNow
    };
  }).filter(x=>x.data_inicio && x.titulo);
}

// ========================
// Envia JSON para Firebase (usando chave canal/dia)
// ========================
async function enviarParaFirebase(canal, dia, jsonData) {
  try {
    // cada canal/dia tem seu próprio caminho
    const url = `https://projeto-aplicativo-android-default-rtdb.firebaseio.com/epg/${canal}/${dia}.json`;
    const resp = await fetch(url, {
      method: 'PUT', // substitui os dados para aquele canal/dia
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(jsonData)
    });
    if(!resp.ok) throw new Error('Falha ao enviar para Firebase: ' + resp.status);
    console.log(`Dados enviados para Firebase em epg/${canal}/${dia}`);
  } catch(err) {
    console.error(err);
  }
}

// ========================
// Função principal
// ========================
async function getProgramacao(canal, dia){
  try{
    const url = `${BASE_URL}${canal}/${dia}`;
    const resp = await fetch(API_PROXY + encodeURIComponent(url));
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const html = await resp.text();
    const itens = parseGrade(html);

    // Exibe no corpo da página (apenas para debug)
    document.body.textContent = JSON.stringify(itens, null, 2);

    // Envia para Firebase
    enviarParaFirebase(canal, dia, itens);

    // Chama interface nativa (caso esteja num WebView)
    if (window.JsonInterface && window.JsonInterface.salvarJson) {
      window.JsonInterface.salvarJson(JSON.stringify(itens, null, 2));
    }

  } catch(err){
    console.error(err);
    document.body.textContent = JSON.stringify({error:"Falha ao carregar programação", details: err.message});
  }
}

// ========================
// Atualização automática (recomendo >= 5 min)
// ========================
getProgramacao(canal, dia);
// Ex.: a cada 5 minutos (300000 ms)
setInterval(()=> getProgramacao(canal, dia), 300000);
</script>
</body>
</html>
