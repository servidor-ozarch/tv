<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Programação Claro TV → Firebase</title>
</head>
<body>
<script>
// ========================
// Configuração
// ========================
const API_PROXY = "https://api.allorigins.win/raw?url=";
const BASE_URL = "https://tvmap.com.br/Claro-TV/";

// ========================
// Detecta parâmetros ?data=xxx
// ========================
const urlParams = new URLSearchParams(location.search);
const dataParam = urlParams.get('data') || getCurrentDateFormatted();

// ========================
// Funções auxiliares
// ========================
function getCurrentDateFormatted() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    return `${day}-${month}-${year}`;
}

function formatData(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

function formatHora(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    const hours = String(d.getHours()).padStart(2, '0');
    const minutes = String(d.getMinutes()).padStart(2, '0');
    return `${hours}:${minutes}`;
}

// ========================
// Parse HTML da programação da Claro TV
// ========================
function parseGradeClaroTV(html) {
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const programRows = Array.from(doc.querySelectorAll('.zc-row.outerTable'));
    const now = Date.now();
    
    return programRows.map(row => {
        try {
            // Extrai informações do canal
            const canalEl = row.querySelector('.zc-st-a');
            const canalNome = canalEl ? canalEl.getAttribute('href').replace('/', '') : '';
            const canalNumero = row.querySelector('.numcanal') ? row.querySelector('.numcanal').textContent.trim() : '';
            
            // Extrai informações do programa atual (primeira célula com programa em exibição)
            const programaCell = row.querySelector('.zc-pg[onclick*="wtc.tvg.ld"]');
            if (!programaCell) return null;
            
            const programaLink = programaCell.querySelector('a.zc-pg-t');
            const programaNome = programaLink ? programaLink.textContent.trim() : '';
            const programaUrl = programaLink ? programaLink.getAttribute('href') : '';
            
            // Extrai informações de tempo
            const tempoElement = programaCell.querySelector('.duracao-filme');
            let tempoDecorrido = '0min';
            let tempoTotal = '0min';
            
            if (tempoElement) {
                const tempoText = tempoElement.textContent;
                const tempoMatch = tempoText.match(/(\d+min)\/(\d+min)/);
                if (tempoMatch) {
                    tempoDecorrido = tempoMatch[1];
                    tempoTotal = tempoMatch[2];
                }
            }
            
            // Extrai horário de término se disponível
            const horarioTerminoEl = programaCell.querySelector('.zc-pg-e');
            const horarioTermino = horarioTerminoEl ? horarioTerminoEl.textContent.trim() : '';
            
            // Determina se é o programa atual
            const isNow = programaCell.querySelector('.tempo') !== null;
            
            return {
                data_atual: formatData(new Date()),
                canal: canalNome,
                numero_canal: canalNumero,
                programa: programaNome,
                programa_url: programaUrl,
                tempo_decorrido: tempoDecorrido,
                tempo_total: tempoTotal,
                horario_termino: horarioTermino,
                isNow: isNow,
                timestamp: now
            };
        } catch (error) {
            console.error('Erro ao parsear linha:', error);
            return null;
        }
    }).filter(item => item !== null && item.isNow); // Filtra apenas programas em exibição no momento
}

// ========================
// Envia JSON para Firebase
// ========================
async function enviarParaFirebase(canal, data, jsonData) {
    try {
        const url = `https://projeto-aplicativo-android-default-rtdb.firebaseio.com/claro_tv/${data}.json`;
        await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jsonData)
        });
        console.log('Dados enviados para Firebase com sucesso');
    } catch(err) {
        console.error('Erro ao enviar para Firebase:', err);
    }
}

// ========================
// Função principal
// ========================
async function getProgramacaoClaroTV(data) {
    try {
        const url = `${BASE_URL}${data}/17.30hs`; // Usando 17:30hs como horário de referência
        const resp = await fetch(API_PROXY + encodeURIComponent(url));
        
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        
        const html = await resp.text();
        const programacao = parseGradeClaroTV(html);
        
        // Exibe resultado na página
        document.body.innerHTML = `<pre>${JSON.stringify(programacao, null, 2)}</pre>`;
        
        // Envia para Firebase
        await enviarParaFirebase('claro_tv', data, programacao);
        
        // Interface com Android (se disponível)
        if (window.JsonInterface && window.JsonInterface.salvarJson) {
            window.JsonInterface.salvarJson(JSON.stringify(programacao, null, 2));
        }
        
    } catch(err) {
        console.error('Erro ao carregar programação:', err);
        document.body.innerHTML = `<pre>${JSON.stringify({error: "Falha ao carregar programação", details: err.message}, null, 2)}</pre>`;
    }
}

// ========================
// Execução principal
// ========================
getProgramacaoClaroTV(dataParam);

// Atualização automática a cada 60s
setInterval(() => getProgramacaoClaroTV(dataParam), 60000);
</script>
</body>
</html>
