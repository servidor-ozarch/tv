<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Programação TV → Firebase</title>
</head>
<body>
<script>
// ========================
// Configuração
// ========================
const API_PROXY = "https://api.allorigins.win/raw?url=";
const BASE_URL = "https://tvmap.com.br/";

// Mapeamento de categorias para gêneros
const generos = {
    'ação': ['ação', 'luta', 'artes marciais', 'guerra', 'combate', 'batalha', 'herói', 'super-herói', 'polícia', 'crime'],
    'aventura': ['aventura', 'expedição', 'missão', 'viagem', 'exploração', 'descoberta', 'aventureiro'],
    'terror': ['terror', 'horror', 'suspense', 'thriller', 'sobrenatural', 'assustador', 'medo', 'fantasma'],
    'ficção científica': ['ficção científica', 'sci-fi', 'futuro', 'espacial', 'alienígena', 'nave', 'robô', 'futurista'],
    'drama': ['drama', 'emocionante', 'romance', 'família', 'relacionamento', 'sentimental', 'amor'],
    'comédia': ['comédia', 'humor', 'divertido', 'engraçado', 'riso', 'zoação', 'humorístico'],
    'documentário': ['documentário', 'realidade', 'história', 'biografia', 'fatos reais', 'documentario'],
    'esportes': ['esporte', 'futebol', 'jogo', 'competição', 'campeonato', 'atleta', 'esportivo'],
    'notícias': ['notícias', 'jornal', 'informação', 'atualidades', 'reportagem', 'noticias'],
    'infantil': ['infantil', 'criança', 'desenho', 'animação', 'kids', 'educativo', 'animado'],
    'entretenimento': ['entretenimento', 'show', 'talento', 'musical', 'reality', 'auditório']
};

// ========================
// Detecta parâmetros ?canal=xxx&dia=xxx
// ========================
const urlParams = new URLSearchParams(location.search);
const canalParam = urlParams.get('canal') || 'Claro-TV';
const diaParam = urlParams.get('dia') || new Date().toLocaleString('pt-BR', { weekday: 'long' }).toLowerCase();

// Mapeamento de dias para formato TV Map
const diasMap = {
    'domingo': 'domingo',
    'segunda': 'segunda-feira', 
    'segunda-feira': 'segunda-feira',
    'terca': 'terca-feira',
    'terça': 'terca-feira',
    'terça-feira': 'terca-feira',
    'quarta': 'quarta-feira',
    'quarta-feira': 'quarta-feira',
    'quinta': 'quinta-feira',
    'quinta-feira': 'quinta-feira',
    'sexta': 'sexta-feira',
    'sexta-feira': 'sexta-feira',
    'sabado': 'sabado',
    'sábado': 'sabado'
};

const diaSlug = diasMap[diaParam] || 'domingo';

// ========================
// Funções auxiliares
// ========================
function getCurrentDateFormatted() {
    const now = new Date();
    const day = String(now.getDate()).padStart(2, '0');
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const year = now.getFullYear();
    return `${day}-${month}-${year}`;
}

function formatData(dt) {
    if (!dt) return '';
    const d = new Date(dt);
    const day = String(d.getDate()).padStart(2, '0');
    const month = String(d.getMonth() + 1).padStart(2, '0');
    const year = d.getFullYear();
    return `${day}/${month}/${year}`;
}

function detectarGenero(titulo) {
    if (!titulo) return 'outros';
    
    const texto = titulo.toLowerCase();
    
    for (const [genero, palavrasChave] of Object.entries(generos)) {
        for (const palavra of palavrasChave) {
            if (texto.includes(palavra)) {
                return genero;
            }
        }
    }
    
    return 'outros';
}

function calcularProgresso(tempoDecorrido, tempoTotal) {
    if (!tempoDecorrido || !tempoTotal) return 0;
    
    const decorrido = parseInt(tempoDecorrido);
    const total = parseInt(tempoTotal);
    
    if (isNaN(decorrido) || isNaN(total) || total === 0) return 0;
    
    return Math.round((decorrido / total) * 100);
}

// ========================
// Parse HTML da programação (versão que funciona)
// ========================
function parseGrade(html) {
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const programRows = Array.from(doc.querySelectorAll('.zc-row.outerTable'));
    const now = Date.now();
    
    return programRows.map(row => {
        try {
            // Extrai informações do canal
            const canalEl = row.querySelector('.zc-st-a');
            const canalNome = canalEl ? canalEl.textContent.trim() : '';
            const canalNumero = row.querySelector('.numcanal') ? row.querySelector('.numcanal').textContent.trim() : '';
            
            // Encontra programas em exibição (com barra de progresso)
            const programaCells = row.querySelectorAll('.zc-pg[onclick*="wtc.tvg.ld"]');
            
            for (const programaCell of programaCells) {
                const tempoElement = programaCell.querySelector('.tempo');
                if (tempoElement) {
                    // Este programa está em exibição agora
                    const programaLink = programaCell.querySelector('a.zc-pg-t');
                    const horarioTerminoEl = programaCell.querySelector('.zc-pg-e');
                    const duracaoElement = programaCell.querySelector('.duracao-filme');
                    
                    const programaNome = programaLink ? programaLink.textContent.trim() : '';
                    const programaUrl = programaLink ? programaLink.getAttribute('href') : '';
                    const horarioTermino = horarioTerminoEl ? horarioTerminoEl.textContent.trim() : '';
                    
                    // Extrai informações de tempo
                    let tempoDecorrido = '0min';
                    let tempoTotal = '0min';
                    
                    if (duracaoElement) {
                        const tempoText = duracaoElement.textContent;
                        const tempoMatch = tempoText.match(/(\d+min)\/(\d+min)/);
                        if (tempoMatch) {
                            tempoDecorrido = tempoMatch[1];
                            tempoTotal = tempoMatch[2];
                        }
                    }
                    
                    // Calcula progresso
                    const progresso = calcularProgresso(tempoDecorrido, tempoTotal);
                    
                    // Detecta gênero
                    const genero = detectarGenero(programaNome);
                    
                    return {
                        data_atual: formatData(new Date()),
                        canal: canalNome,
                        numero_canal: canalNumero,
                        programa: programaNome,
                        programa_url: programaUrl,
                        tempo_decorrido: tempoDecorrido,
                        tempo_total: tempoTotal,
                        progresso: progresso,
                        genero: genero,
                        horario_termino: horarioTermino,
                        isNow: true,
                        timestamp: now,
                        consulta: new Date().toISOString()
                    };
                }
            }
            
            return null;
        } catch (error) {
            console.error('Erro ao parsear linha:', error);
            return null;
        }
    }).filter(item => item !== null);
}

// ========================
// Envia JSON para Firebase
// ========================
async function enviarParaFirebase(canal, dia, jsonData) {
    try {
        const url = `https://projeto-aplicativo-android-default-rtdb.firebaseio.com/epg/${canal}/${dia}.json`;
        await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(jsonData)
        });
        console.log('Dados enviados para Firebase com sucesso');
    } catch(err) {
        console.error('Erro ao enviar para Firebase:', err);
    }
}

// ========================
// Função principal (usando horário fixo que funciona)
// ========================
async function getProgramacao(canal, dia) {
    try {
        // Usa horário fixo que sabemos que funciona (17.30hs)
        // O TV Map tem grades horárias específicas
        let url;
        
        if (canal.toLowerCase() === 'claro-tv') {
            const dataAtual = getCurrentDateFormatted();
            url = `${BASE_URL}${canal}/${dataAtual}/17.30hs`;
        } else {
            url = `${BASE_URL}${canal}/${dia}/17.30hs`;
        }
        
        console.log('Acessando URL:', url);
        
        const resp = await fetch(API_PROXY + encodeURIComponent(url));
        
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        
        const html = await resp.text();
        const programacao = parseGrade(html);
        
        // Exibe resultado na página
        document.body.innerHTML = `<pre>${JSON.stringify(programacao, null, 2)}</pre>`;
        
        // Envia para Firebase
        await enviarParaFirebase(canal, dia, programacao);
        
        // Interface com Android
        if (window.JsonInterface && window.JsonInterface.salvarJson) {
            window.JsonInterface.salvarJson(JSON.stringify(programacao, null, 2));
        }
        
    } catch(err) {
        console.error('Erro ao carregar programação:', err);
        document.body.innerHTML = `<pre>${JSON.stringify({
            error: "Falha ao carregar programação", 
            details: err.message,
            suggestion: "Tente novamente ou verifique se o site está acessível"
        }, null, 2)}</pre>`;
    }
}

// ========================
// Execução principal
// ========================
getProgramacao(canalParam, diaSlug);

// Atualização automática a cada 60s
setInterval(() => getProgramacao(canalParam, diaSlug), 60000);
</script>
</body>
</html>
