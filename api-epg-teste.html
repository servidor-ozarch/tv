<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>API EPG Teste - Claro TV</title>
</head>
<body>
<script>
// ========================
// Configuração
// ========================
const API_PROXY = "https://api.allorigins.win/raw?url=";
const BASE_URL = "https://tvmap.com.br/Claro-TV/";

// ========================
// Funções auxiliares
// ========================
function getCurrentDateFormatted() {
  const now = new Date();
  return `${String(now.getDate()).padStart(2,'0')}-${String(now.getMonth()+1).padStart(2,'0')}-${now.getFullYear()}`;
}
function getCurrentTimeFormatted() {
  const now = new Date();
  const h = String(now.getHours()).padStart(2, '0');
  const m = Math.floor(now.getMinutes() / 5) * 5; // arredonda para 5 min
  return `${h}.${String(m).padStart(2, '0')}hs`;
}
function formatData(dt) {
  const d = new Date(dt);
  return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}
function horaParaTimestamp(horaStr) {
  if (!horaStr) return null;
  const partes = horaStr.split(':');
  if (partes.length < 2) return null;
  const hoje = new Date();
  return new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate(), parseInt(partes[0],10), parseInt(partes[1],10), 0).getTime();
}

// ========================
// Parser
// ========================
function parseGradeClaroTV(html) {
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const linhas = Array.from(doc.querySelectorAll('.zc-row.outerTable'));
  const agora = Date.now();
  const resultado = {};

  for (const row of linhas) {
    try {
      const canalEl = row.querySelector('.zc-st-a');
      const canalNome = canalEl ? canalEl.getAttribute('href').replace('/', '') : '';
      if (!canalNome) continue;
      const canalNumero = row.querySelector('.numcanal') ? row.querySelector('.numcanal').textContent.trim() : '';

      const programas = Array.from(row.querySelectorAll('.zc-pg'));
      let programaAtual = null;
      for (const cell of programas) {
        const inicioEl = cell.querySelector('.zc-pg-s');
        const fimEl = cell.querySelector('.zc-pg-e');
        const inicio = inicioEl ? inicioEl.textContent.trim() : '';
        const fim = fimEl ? fimEl.textContent.trim() : '';
        if (cell.querySelector('.tempo')) { // marcador visual
          programaAtual = { cell, inicio, fim };
          break;
        }
        const iniTs = horaParaTimestamp(inicio);
        const fimTs = horaParaTimestamp(fim);
        if (iniTs && fimTs && agora >= iniTs && agora <= fimTs) {
          programaAtual = { cell, inicio, fim };
          break;
        }
      }
      if (!programaAtual) continue;

      const cell = programaAtual.cell;
      const link = cell.querySelector('a.zc-pg-t');
      const progNome = link ? link.textContent.trim() : '';
      const progUrl = link ? link.getAttribute('href') : '';

      let decorrido = '';
      let total = '';
      let porcentagem = '';
      const barra = cell.querySelector('.duracao-filme'); 
      if (barra) {
        const t = barra.textContent.trim();
        const match = t.match(/(\d+)min\/(\d+)min/);
        if (match) {
          decorrido = match[1];
          total = match[2];
          if (parseInt(total) > 0) {
            porcentagem = ((parseInt(decorrido)/parseInt(total))*100).toFixed(1)+'%';
          }
        }
      }

      resultado[canalNome] = {
        data: formatData(new Date()),
        numero_canal: canalNumero,
        programa: progNome,
        programa_url: progUrl,
        horario_inicio: programaAtual.inicio,
        horario_fim: programaAtual.fim,
        horario_inicio_ts: horaParaTimestamp(programaAtual.inicio),
        horario_fim_ts: horaParaTimestamp(programaAtual.fim),
        tempo_decorrido: decorrido,
        tempo_total: total,
        porcentagem_progresso: porcentagem,
        timestamp_consulta: agora
      };
    } catch(e){ console.warn("Erro:", e); }
  }
  return resultado;
}

// ========================
// Firebase
// ========================
async function enviarParaFirebase(dia, jsonData) {
  try {
    const url = `https://projeto-aplicativo-android-default-rtdb.firebaseio.com/claro_tv/${dia}.json`;
    await fetch(url, {
      method: 'PUT',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(jsonData)
    });
    console.log("Firebase atualizado.");
  } catch(err){ console.error("Erro Firebase:", err); }
}

// ========================
// Execução principal
// ========================
async function getEPG() {
  const params = new URLSearchParams(location.search);
  const canalParam = params.get('canal');
  const diaParam = params.get('dia') || getCurrentDateFormatted();
  const hora = getCurrentTimeFormatted();

  try {
    const url = `${BASE_URL}${diaParam}/${hora}`;
    console.log("Buscando:", url);
    const resp = await fetch(API_PROXY + encodeURIComponent(url));
    if (!resp.ok) throw new Error("HTTP "+resp.status);

    const html = await resp.text();
    const epg = parseGradeClaroTV(html);

    // Firebase com todos os canais
    await enviarParaFirebase(diaParam, epg);

    // Exibe apenas o canal solicitado, se houver
    let exibicao = epg;
    if (canalParam && epg[canalParam]) {
      exibicao = {[canalParam]: epg[canalParam]};
    } else if (canalParam) {
      exibicao = {error:`Canal ${canalParam} não encontrado.`};
    }

    document.body.innerHTML = `<pre>${JSON.stringify(exibicao, null, 2)}</pre>`;

  } catch(err) {
    document.body.innerHTML = `<pre>${JSON.stringify({error:"Falha ao carregar programação", detalhe: err.message}, null, 2)}</pre>`;
  }
}

// Atualiza
getEPG();
setInterval(getEPG, 60000);
</script>
</body>
</html>
