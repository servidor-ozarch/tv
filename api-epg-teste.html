<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Programação TV → Firebase</title>
</head>
<body>
<script>
// ========================
// Configuração
// ========================
const API_PROXY = "https://api.allorigins.win/raw?url=";
const BASE_URL = "https://tvinside.com.br/programacao_tv/";

const dias = {
  domingo: 'domingo',
  segunda: 'segunda',
  terca: 'terca',
  quarta: 'quarta',
  quinta: 'quinta',
  sexta: 'sexta',
  sabado: 'sabado'
};

// ========================
// Detecta parâmetros ?canal=xxx&dia=xxx
// ========================
const urlParams = new URLSearchParams(location.search);
const canal = urlParams.get('canal') || 'cinemax';
const diaParam = urlParams.get('dia') || new Date().toLocaleString('pt-BR', { weekday: 'long' }).toLowerCase();
const diaSlug = dias[diaParam] || 'domingo';

// ========================
// Formatação de data e hora
// ========================
function formatData(dt){
  if(!dt) return '';
  const d = new Date(dt);
  const day = String(d.getDate()).padStart(2,'0');
  const month = String(d.getMonth()+1).padStart(2,'0');
  const year = d.getFullYear();
  return `${day}/${month}/${year}`;
}

function formatHora(dt){
  if(!dt) return '';
  const d = new Date(dt);
  const hours = String(d.getHours()).padStart(2,'0');
  const minutes = String(d.getMinutes()).padStart(2,'0');
  return `${hours}:${minutes}`;
}

// ========================
// Parse HTML da programação
// ========================
function parseGrade(html){
  const doc = new DOMParser().parseFromString(html, 'text/html');
  const regs = Array.from(doc.querySelectorAll('.registro.programa_data'));
  const now = Date.now();

  return regs.map(el=>{
    const titleEl = el.querySelector('.titulo');
    const catEl   = el.querySelector('.evento_box small');
    const sinopseEl = el.querySelector('.descricao_programa'); 
    const classificacaoEl = el.querySelector('.classificacao'); 
    const faixaEl = el.querySelector('.faixa_etaria'); 

    const dti = el.getAttribute('dti');
    const dtf = el.getAttribute('dtf');

    const startDate = dti ? new Date(dti.replace(' ','T')) : null;
    const endDate   = dtf ? new Date(dtf.replace(' ','T')) : null;

    const isNow = (startDate && endDate && now >= startDate.getTime() && now < endDate.getTime()) || el.classList.contains('check_noar');

    return {
      data_atual: formatData(new Date()),      // data de hoje
      data_inicio: formatData(startDate),
      hora_inicio: formatHora(startDate),
      data_fim: formatData(endDate),
      hora_fim: formatHora(endDate),
      titulo: titleEl ? titleEl.textContent.trim() : '',
      categoria: catEl ? catEl.textContent.trim() : '',
      sinopse: sinopseEl ? sinopseEl.textContent.trim() : '',
      classificacao: classificacaoEl ? classificacaoEl.textContent.trim() : '',
      faixa: faixaEl ? faixaEl.textContent.trim() : '',
      isNow,
      startTime: startDate ? startDate.getTime() : null
    };
  }).filter(x=>x.isNow); // filtra somente o programa atual
}

// ========================
// Envia JSON para Firebase
// ========================
async function enviarParaFirebase(canal, dia, jsonData) {
  try {
    const url = `https://projeto-aplicativo-android-default-rtdb.firebaseio.com/epg/${canal}/${dia}.json`;
    await fetch(url, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(jsonData)
    });
  } catch(err) {
    console.error(err);
  }
}

// ========================
// Função principal
// ========================
async function getProgramacao(canal, dia){
  try{
    const url = `${BASE_URL}${canal}/${dia}`;
    const resp = await fetch(API_PROXY + encodeURIComponent(url));
    if(!resp.ok) throw new Error('HTTP ' + resp.status);
    const html = await resp.text();
    const itens = parseGrade(html);

    const atual = itens[0] || null;

    document.body.textContent = JSON.stringify(atual, null, 2);

    enviarParaFirebase(canal, dia, atual);

    if (window.JsonInterface && window.JsonInterface.salvarJson) {
      window.JsonInterface.salvarJson(JSON.stringify(atual, null, 2));
    }

  } catch(err){
    console.error(err);
    document.body.textContent = JSON.stringify({error:"Falha ao carregar programação", details: err.message});
  }
}

// ========================
// Atualização automática a cada 60s
// ========================
getProgramacao(canal, diaSlug);
setInterval(()=> getProgramacao(canal, diaSlug), 60000);
</script>
</body>
</html>
