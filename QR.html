<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Leitor de QR Code</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #121212;
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }
  header {
    padding: 15px;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
    background: #1f1f1f;
    width: 100%;
    box-shadow: 0 2px 6px rgba(0,0,0,0.5);
  }
  #video {
    display: none;
  }
  #canvas {
    width: 500px;
    height: 500px;
    max-width: 90vw;
    max-height: 90vw;
    background: #000;
    border-radius: 12px;
    margin: 15px 0;
    box-shadow: 0 0 12px rgba(0, 255, 128, 0.3);
  }
  #results {
    background: #1f1f1f;
    width: 100%;
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    border-top: 2px solid #333;
  }
  .result-item {
    padding: 8px;
    margin-bottom: 6px;
    background: #292929;
    border-radius: 6px;
    font-size: 14px;
    word-break: break-all;
  }
  .result-item a {
    color: #4dabf7;
    text-decoration: none;
  }
</style>
</head>
<body>

<header>ðŸ“· Leitor de QR Code</header>
<video id="video" autoplay></video>
<canvas id="canvas"></canvas>

<div id="results">Resultados:</div>

<script src="https://servidor-ozarch.github.io/tv/jsQR.js"></script>
<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const resultsDiv = document.getElementById('results');

let scanning = false;
let track = null;

async function startScanner() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { 
        facingMode: "environment", // cÃ¢mera traseira para leitura
        width: { ideal: 1280 },
        height: { ideal: 1280 },
        aspectRatio: 1
      }
    });
    
    video.srcObject = stream;
    video.setAttribute("playsinline", true);
    await video.play();
    scanning = true;

    [track] = stream.getVideoTracks();
    const capabilities = track.getCapabilities();

    // foco contÃ­nuo
    if (capabilities.focusMode) {
      try {
        await track.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
      } catch (e) {
        console.warn("Foco contÃ­nuo nÃ£o suportado:", e);
      }
    }

    // forÃ§a zoom 100% se suportado
    if (capabilities.zoom) {
      try {
        await track.applyConstraints({ advanced: [{ zoom: 1 }] }); // 1 = 100%
      } catch(e) {
        console.warn("Zoom fixo nÃ£o suportado:", e);
      }
    }

    requestAnimationFrame(scanFrame);
  } catch (err) {
    alert("Erro ao acessar a cÃ¢mera: " + err);
  }
}

function scanFrame() {
  if (!scanning) return;

  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    canvas.width = 500;
    canvas.height = 500;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height, {
      inversionAttempts: "dontInvert"
    });

    if (code) {
      addResult(code.data);
      setTimeout(() => {
        scanning = true;
        requestAnimationFrame(scanFrame);
      }, 1500);
      return;
    }
  }
  requestAnimationFrame(scanFrame);
}

function addResult(text) {
  const div = document.createElement("div");
  div.className = "result-item";
  div.innerHTML = text.startsWith("http")
    ? `<a href="${text}" target="_blank">${text}</a>`
    : text;
  resultsDiv.appendChild(div);
}

window.onload = () => {
  startScanner();
};
</script>
</body>
</html>
