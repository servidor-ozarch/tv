<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Programação TV → Firebase (mi.tv AJAX)</title>
</head>
<body>
<script>
const API_PROXY = "https://api.allorigins.win/raw?url=";
// Substitua por endpoint real se encontrado
const AJAX_URL = "https://mi.tv/xhr/epg"; 

const urlParams = new URLSearchParams(location.search);
const canal = (urlParams.get('canal') || '').toLowerCase();

function normalizar(t){
  return (t||'').toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/\s+/g,' ')
    .trim();
}

async function getProgramacao() {
  try {
    const resp = await fetch(API_PROXY + encodeURIComponent(AJAX_URL));
    if (!resp.ok) throw new Error('HTTP ' + resp.status);
    const data = await resp.json(); // Se for JSON
    let itens = [];

    // Exemplo de parsing – ajuste conforme o formato real
    data.channels.forEach(ch => {
      const nome = ch.name || '';
      if (canal && !normalizar(nome).includes(canal)) return;

      ch.programs.forEach(p => {
        itens.push({
          canal: nome,
          hora_inicio: p.start_time,
          hora_fim: p.end_time,
          titulo: p.title,
          descricao: p.description || ''
        });
      });
    });

    document.body.textContent = JSON.stringify(itens, null, 2);

    // Envia para Firebase
    await fetch('https://projeto-aplicativo-android-default-rtdb.firebaseio.com/epg.json', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(itens)
    });

  } catch (err) {
    document.body.textContent = JSON.stringify({erro: err.message});
  }
}

getProgramacao();
</script>
</body>
</html>
